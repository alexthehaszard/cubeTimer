!function(t,s){"object"==typeof exports&&"undefined"!=typeof module?module.exports=s():"function"==typeof define&&define.amd?define(s):(t=t||self).Stackmat=s()}(this,(function(){"use strict";var t;function s(t){return-1!=="IA SLRC".indexOf(String.fromCharCode(t))}function e(t){return-1!=="0123456789".indexOf(String.fromCharCode(t))}function i(t,s){return t===s.map(t=>Number(String.fromCharCode(t))).reduce((t,s)=>t+s)+64}!function(t){t.IDLE="I",t.STARTING="A",t.RUNNING=" ",t.STOPPED="S",t.LEFT_HAND="L",t.RIGHT_HAND="R",t.BOTH_HANDS="C",t.INVALID="X"}(t||(t={}));class n{constructor(s,e,i,n){this.isValid=s,this.status=e||t.INVALID,this.stringDigits=i||[],this.timeInMilliseconds=n||0}get timeAsString(){return this.stringDigits.slice(0,1)+":"+this.stringDigits.slice(1,3).join("")+"."+this.stringDigits.slice(3).join("")}get isLeftHandDown(){return this.status===t.LEFT_HAND||this.status===t.BOTH_HANDS||this.status===t.STARTING}get isRightHandDown(){return this.status===t.RIGHT_HAND||this.status===t.BOTH_HANDS||this.status===t.STARTING}get areBothHandsDown(){return this.status===t.BOTH_HANDS||this.status===t.STARTING}}class a extends n{static isValid(t){return 9===t.length&&s(t[0])&&e(t[1])&&e(t[2])&&e(t[3])&&e(t[4])&&e(t[5])&&i(t[6],t.slice(1,6))&&10===t[7]&&13===t[8]}constructor(t){if(a.isValid(t)){const s=String.fromCharCode(t[0]),e=t.slice(1,6).map(t=>String.fromCharCode(t)),i=Number(e[0]),n=Number(e.slice(1,3).join("")),a=Number(e.slice(3).join("")+"0");super(!0,s,e,6e4*i+1e3*n+a)}else super(!1)}}class o extends n{static isValid(t){return 10===t.length&&s(t[0])&&e(t[1])&&e(t[2])&&e(t[3])&&e(t[4])&&e(t[5])&&e(t[6])&&i(t[7],t.slice(1,7))&&10===t[8]&&13===t[9]}constructor(t){if(o.isValid(t)){const s=String.fromCharCode(t[0]),e=t.slice(1,7).map(t=>String.fromCharCode(t)),i=Number(e[0]),n=Number(e.slice(1,3).join("")),a=Number(e.slice(3).join(""));super(!0,s,e,6e4*i+1e3*n+a)}else super(!1)}}class r{constructor(t,s){this.ticksPerBit=t/1200,this.callback=s}decode(t){let s=[];for(const e of t)s.push(e<=0?1:0);const e=this.findBeginningOfSignal(s),i=function(t){let s=-1;const e=[];for(const i of t)s!==i?(e.push({bit:i,length:1}),s=i):e[e.length-1].length++;return e}(s.slice(e)),n=function(t){const s=[];for(let e=0;e<=9;e++)s.push(c(t,10*e));let e=new o(s);return e.isValid?e:e=new a(s.slice(0,-1))}((s=this.getBitsFromRunLengthEncodedSignal(i)).slice(1));n.isValid&&this.callback(n)}findBeginningOfSignal(t){let s=0,e=!1;for(let i=0;i<t.length;i++)if(1===t[i])++s>9*this.ticksPerBit&&(e=!0);else if(s=0,e)return i}getBitsFromRunLengthEncodedSignal(t){const s=t.map(t=>Array(Math.round(t.length/this.ticksPerBit)).fill(t.bit));return[].concat(...s)}}function c(t,s){let e=0;for(let i=0;i<8;i++)e+=t[s+i]<<i;return e}class h{constructor(t){this.callback=t}start(){navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!1,noiseSuppression:!1}}).then(t=>{this.stream=t,this.context=new AudioContext,this.source=this.context.createMediaStreamSource(this.stream),this.scriptNode=this.context.createScriptProcessor(8192,1,1);const s=new r(this.context.sampleRate,this.callback);this.scriptNode.onaudioprocess=t=>{s.decode(t.inputBuffer.getChannelData(0))},this.source.connect(this.scriptNode),this.scriptNode.connect(this.source.context.destination)}).catch(t=>{console.error(t)})}stop(){this.context&&this.source&&this.scriptNode&&(this.source.disconnect(this.scriptNode),this.scriptNode.disconnect(this.context.destination),this.scriptNode=void 0,this.source=void 0,this.context.close().finally(()=>{this.context=void 0})),this.stream&&(this.stream.getTracks().forEach(t=>t.stop()),this.stream=void 0)}}const d=(t=>t)(["packetReceived","timerConnected","timerDisconnected","started","stopped","reset","ready","unready","starting","leftHandDown","leftHandUp","rightHandDown","rightHandUp"]),l=t=>d.includes(t);class u{constructor(){this.lastPacketRunning=!1,this.lastPacketReset=!1,this.handlers=new Map,this.connected=!1,this.lastPacketReceived=0,this.connectionTimout=1e3,this.connectionTimer=setInterval(()=>{this.connected&&this.lastPacketReceived+this.connectionTimout<Date.now()?(this.connected=!1,this.fire("timerDisconnected")):!this.connected&&this.lastPacketReceived+this.connectionTimout>Date.now()&&(this.connected=!0,this.fire("timerConnected"))},100,this)}on(t,s){if(l(t)){const e=this.handlers.get(t)||[];e.push(s),this.handlers.set(t,e)}}off(t){t&&l(t)&&this.handlers.has(t)?this.handlers.delete(t):t||this.handlers.clear()}receivePacket(s){this.lastPacketReceived=Date.now(),this.fire("packetReceived",s),this.lastPacket&&(this.lastPacket.isLeftHandDown&&!s.isLeftHandDown?this.fire("leftHandUp",s):!this.lastPacket.isLeftHandDown&&s.isLeftHandDown&&this.fire("leftHandDown",s),this.lastPacket.isRightHandDown&&!s.isRightHandDown?this.fire("rightHandUp",s):!this.lastPacket.isRightHandDown&&s.isRightHandDown&&this.fire("rightHandDown",s),this.lastPacket.areBothHandsDown||s.status!==t.BOTH_HANDS||0!==this.lastPacket.timeInMilliseconds||this.fire("ready",s),this.lastPacket.status!==t.BOTH_HANDS||s.areBothHandsDown||s.status===t.RUNNING||0!==s.timeInMilliseconds||this.fire("unready",s),this.lastPacket.status===t.BOTH_HANDS&&s.status===t.STARTING&&this.fire("starting",s),!this.lastPacketRunning&&(s.status===t.RUNNING||0===this.lastPacket.timeInMilliseconds&&s.timeInMilliseconds>0)&&(this.lastPacketRunning=!0,this.lastPacketReset=!1,this.fire("started",s)),this.lastPacketRunning&&(s.status===t.STOPPED||s.status===t.BOTH_HANDS||this.lastPacket.timeInMilliseconds===s.timeInMilliseconds&&s.timeInMilliseconds>0)&&(this.lastPacketRunning=!1,this.lastPacketReset=!1,this.lastPacket.isLeftHandDown||s.isLeftHandDown||this.fire("leftHandDown",s),this.lastPacket.isRightHandDown||s.isRightHandDown||this.fire("rightHandDown",s),this.fire("stopped",s),this.lastPacket.isLeftHandDown||s.isLeftHandDown||this.fire("leftHandUp",s),this.lastPacket.isRightHandDown||s.isRightHandDown||this.fire("rightHandUp",s)),this.lastPacketReset||s.status!==t.IDLE||(this.lastPacketRunning=!1,this.lastPacketReset=!0,this.fire("reset",s))),this.lastPacket=s}fire(t,s){for(const e of this.handlers.get(t)||[])e(s)}}return class{constructor(){this.eventManager=new u}on(t,s){return!!l(t)&&(this.eventManager.on(t,s),!0)}off(t){return!(t&&!l(t))&&(this.eventManager.off(t),!0)}start(){this.audioProcessor&&this.stop(),this.audioProcessor=new h(t=>this.eventManager.receivePacket(t)),this.audioProcessor.start()}stop(){this.audioProcessor&&(this.audioProcessor.stop(),this.audioProcessor=void 0)}}}));
